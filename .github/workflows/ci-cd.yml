name: AI-RecoverOps CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  ML_API_IMAGE: ai-recoverops/ml-api
  DASHBOARD_IMAGE: ai-recoverops/dashboard

jobs:
  # Test ML Model
  test-ml-model:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('ml/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install ML dependencies
      run: |
        cd ml
        pip install -r requirements.txt

    - name: Generate synthetic data
      run: |
        cd data
        python generate_synthetic_logs.py

    - name: Train and test ML models
      run: |
        cd ml
        python model_training.py

    - name: Upload model artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ml-models
        path: models/
        retention-days: 30

  # Test API
  test-api:
    runs-on: ubuntu-latest
    needs: test-ml-model
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: ml-models
        path: models/

    - name: Install API dependencies
      run: |
        cd api
        pip install -r requirements.txt

    - name: Start Redis for testing
      uses: supercharge/redis-github-action@1.7.0
      with:
        redis-version: 7

    - name: Run API tests
      run: |
        cd api
        python -m pytest tests/ -v --cov=. --cov-report=xml

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./api/coverage.xml
        flags: api
        name: api-coverage

  # Test Dashboard
  test-dashboard:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json

    - name: Install dashboard dependencies
      run: |
        cd dashboard
        npm ci

    - name: Run dashboard tests
      run: |
        cd dashboard
        npm test -- --coverage --watchAll=false

    - name: Build dashboard
      run: |
        cd dashboard
        npm run build

    - name: Upload dashboard build
      uses: actions/upload-artifact@v3
      with:
        name: dashboard-build
        path: dashboard/build/
        retention-days: 30

  # Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Bandit security linter
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json || true

    - name: Upload Bandit results
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          trivy-results.sarif
          bandit-report.json

  # Build and Push Docker Images
  build-and-push:
    runs-on: ubuntu-latest
    needs: [test-ml-model, test-api, test-dashboard, security-scan]
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Download model artifacts
      uses: actions/download-artifact@v3
      with:
        name: ml-models
        path: models/

    - name: Download dashboard build
      uses: actions/download-artifact@v3
      with:
        name: dashboard-build
        path: dashboard/build/

    - name: Build ML API Docker image
      run: |
        cd api
        docker build -t $ECR_REGISTRY/$ML_API_IMAGE:$GITHUB_SHA .
        docker tag $ECR_REGISTRY/$ML_API_IMAGE:$GITHUB_SHA $ECR_REGISTRY/$ML_API_IMAGE:latest

    - name: Build Dashboard Docker image
      run: |
        cd dashboard
        docker build -t $ECR_REGISTRY/$DASHBOARD_IMAGE:$GITHUB_SHA .
        docker tag $ECR_REGISTRY/$DASHBOARD_IMAGE:$GITHUB_SHA $ECR_REGISTRY/$DASHBOARD_IMAGE:latest

    - name: Push ML API image to ECR
      run: |
        docker push $ECR_REGISTRY/$ML_API_IMAGE:$GITHUB_SHA
        docker push $ECR_REGISTRY/$ML_API_IMAGE:latest

    - name: Push Dashboard image to ECR
      run: |
        docker push $ECR_REGISTRY/$DASHBOARD_IMAGE:$GITHUB_SHA
        docker push $ECR_REGISTRY/$DASHBOARD_IMAGE:latest

    - name: Update ECS service
      run: |
        aws ecs update-service \
          --cluster ai-recoverops-cluster \
          --service ai-recoverops-ml-api \
          --force-new-deployment \
          --region $AWS_REGION

        aws ecs update-service \
          --cluster ai-recoverops-cluster \
          --service ai-recoverops-dashboard \
          --force-new-deployment \
          --region $AWS_REGION

  # Deploy Lambda Functions
  deploy-lambda:
    runs-on: ubuntu-latest
    needs: [test-ml-model, test-api]
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Package Lambda functions
      run: |
        # Package log processor
        cd aws/lambda_functions
        mkdir -p log_processor_package
        cp log_processor.py log_processor_package/
        pip install -r ../../api/requirements.txt -t log_processor_package/
        cd log_processor_package
        zip -r ../log_processor.zip .
        cd ..

        # Package remediation executor
        mkdir -p remediation_executor_package
        cp remediation_executor.py remediation_executor_package/
        cp -r ../../remediation remediation_executor_package/
        pip install boto3 -t remediation_executor_package/
        cd remediation_executor_package
        zip -r ../remediation_executor.zip .
        cd ..

    - name: Deploy log processor Lambda
      run: |
        aws lambda update-function-code \
          --function-name ai-recoverops-log-processor \
          --zip-file fileb://aws/lambda_functions/log_processor.zip \
          --region $AWS_REGION

    - name: Deploy remediation executor Lambda
      run: |
        aws lambda update-function-code \
          --function-name ai-recoverops-remediation-executor \
          --zip-file fileb://aws/lambda_functions/remediation_executor.zip \
          --region $AWS_REGION

  # Infrastructure Deployment
  deploy-infrastructure:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Terraform Init
      run: |
        cd deployment/terraform
        terraform init

    - name: Terraform Plan
      run: |
        cd deployment/terraform
        terraform plan -out=tfplan

    - name: Terraform Apply
      run: |
        cd deployment/terraform
        terraform apply -auto-approve tfplan

  # Performance Testing
  performance-test:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: Run performance tests
      run: |
        k6 run tests/performance/load_test.js

    - name: Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: performance-results.json

  # Notification
  notify:
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-lambda, deploy-infrastructure]
    if: always()
    steps:
    - name: Notify Slack on success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#devops'
        text: '✅ AI-RecoverOps deployment successful!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Slack on failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#devops'
        text: '❌ AI-RecoverOps deployment failed!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# Workflow for manual deployment to staging
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add staging deployment commands here